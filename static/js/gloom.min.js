(async()=>{document.body.style.margin="0";const k=new TextDecoder("utf-8"),n=document.getElementById("viewport"),h=n.getContext("2d");n.style.transformOrigin="top left",n.style.position="absolute",n.style.top="50%",n.style.left="50%",n.style.imageRendering="pixelated";let c=null,d=null;function g(){return Math.floor(Math.random()*4294967295)}function x(e,t,r){const i=k.decode(a.buffer.slice(t,t+r));switch(e){case 1:console.log(i);break;case 2:console.error(i);break;default:break}}function L(e){const t=e+65536-1>>16,r=c.byteOffset,i=c.byteLength,j=d.width,C=d.height;return a.grow(t),m(r,j,C,i),t<<16}function m(e,t,r,i){c=new Uint8ClampedArray(a.buffer,e,i),d=new ImageData(c,t,r),n.width=t,n.height=r}function l(){return document.pointerLockElement===n}async function E(){if(!l())try{await n.requestPointerLock({unadjustedMovement:!0})}catch(e){e.name==="NotSupportedError"?(console.warn("disabling mouse acceleration is not supported: %s",e),await n.requestPointerLock()):console.error("could not lock pointer: %s",e)}}function _(){document.exitPointerLock()}function A(e,t){try{return s.send(a.buffer.slice(e,e+t)),t}catch{return-1}}const D=Date.now();function S(){return(Date.now()-D)/1e3}const q={env:{write:x,pointer_lock:E,pointer_release:_,request_mem:L,register_fb:m,send_packet:A,time:S}},o=(await WebAssembly.instantiateStreaming(fetch("/static/js/gloom.wasm"),q)).instance,a=o.exports.memory;function f(){const e=window.innerWidth/n.width,t=window.innerHeight/n.height,r=Math.min(e,t);n.style.transform=`scale(${r}) translate(-50%, -50%)`}function w(e){o.exports.key_event(e.keyCode,e.key.charCodeAt(0),e.type==="keydown")}document.addEventListener("pointerlockchange",()=>o.exports.set_pointer_locked(l())),window.addEventListener("load",f),window.addEventListener("resize",f),window.addEventListener("keydown",w),window.addEventListener("keyup",w),n.addEventListener("mousedown",e=>o.exports.mouse_down(e.offsetX,e.offsetY,e.button)),n.addEventListener("mouseup",e=>o.exports.mouse_up(e.offsetX,e.offsetY,e.button)),n.addEventListener("mousemove",e=>o.exports.mouse_moved(e.offsetX,e.offsetY,e.movementX,e.movementY));let u;function p(e){const t=(e-u)/1e3;o.exports.tick(t),h.putImageData(d,0,0),u=e,window.requestAnimationFrame(p)}function F(e){data=new ArrayBuffer(8),view=new DataView(data),view.setUint32(0,e,!0),view.setUint32(4,3134984190,!0),s.send(data)}function y(e){s.removeEventListener("error",b),s.removeEventListener("open",v);const t=g();e&&F(t),o.exports.init(e,t),window.requestAnimationFrame(r=>{f(),u=r,window.requestAnimationFrame(p)})}const b=()=>y(!1),v=()=>y(!0),T=`ws://${window.location.hostname}:8492`,s=new WebSocket(T);s.binaryType="arraybuffer",s.addEventListener("message",e=>{if(e.data instanceof ArrayBuffer){const t=new Uint8Array(e.data);new Uint8Array(a.buffer,o.exports.__pkt_buf,4096).set(t),o.exports.multiplayer_on_recv(t.byteLength)}}),s.addEventListener("error",b),s.addEventListener("open",v)})();
